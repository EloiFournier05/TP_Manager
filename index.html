<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Classement ATP (Alcoholic Tibo Pinart)</title>
  <style>
    :root{
      --bg:#0b0b0c; --card:#141416; --border:#242428;
      --text:#f5f5f7; --muted:#a1a1aa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1100px; margin:20px auto; padding:0 16px 40px}
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      background:#0f0f11; border:1px solid var(--border); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:650;
      opacity:.85;
    }
    .tab.active{opacity:1; border-color:#3a3a40}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{font-size:18px; margin:0}
    h2{font-size:14px; margin:0 0 10px; color:var(--muted); font-weight:650}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:left}
    th{color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.2px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; color:var(--muted)}
    input, select{
      background:#0f0f11; color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px; outline:none;
    }
    input[type="number"]{width:120px}
    .btn{
      background:#fff; color:#0b0b0c;
      border:none; border-radius:12px;
      padding:10px 14px; font-weight:750;
      cursor:pointer;
    }
    .btn2{
      background:#0f0f11; color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 14px; cursor:pointer;
    }
    .muted{color:var(--muted)}
    .notice{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
    .danger{color:#ef4444}
    .playerLine{
      display:grid;
      grid-template-columns: 1fr 140px 160px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid var(--border);
    }
    .playerLine:last-child{border-bottom:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Classement ATP (Alcoholic Tibo Pinart)</h1>
      <div class="tabs">
        <button class="tab active" data-view="ranking">Classement</button>
        <button class="tab" data-view="add">Ajouter un tournoi</button>
        <button class="tab" data-view="jerseys">Maillots</button>
      </div>
    </div>

    <div class="card" id="view-ranking"></div>
    <div class="card" id="view-add" style="display:none"></div>
    <div class="card" id="view-jerseys" style="display:none"></div>
  </div>

<script>
(() => {
  // ---------------- Config ----------------
  const P_EXP = 1.3;
  const MIN_FRAC = 0.10;

  const TOURNAMENTS = [
    { key:"major", name:"Major", base:1500 },
    { key:"monster1000", name:"Monster 1000", base:1000 },
    { key:"murge500", name:"Murge 500", base:500 },
    { key:"chamangeurs250", name:"Chamangeurs 250", base:250 },
    { key:"golems100", name:"Golems 100", base:100 }
  ];

  const DEFAULT_JERSEYS = [
    "Maillot Jaune",
    "Maillot Vert",
    "Maillot à Pois",
    "Maillot Blanc"
  ];

  // ---------------- Storage ----------------
  const KEY = "atp_tibo_v1";

  function loadState(){
    const raw = localStorage.getItem(KEY);
    if (!raw){
      return {
        players: [],              // [{id,name}]
        tournaments: [],          // [{id,dateISO,typeKey,players:[{playerId,rank,teamPos?}]}]
        jerseys: DEFAULT_JERSEYS.map(j => ({ jersey: j, holderPlayerId: null }))
      };
    }
    try{
      const s = JSON.parse(raw);
      if (!s.players) s.players = [];
      if (!s.tournaments) s.tournaments = [];
      if (!s.jerseys) s.jerseys = DEFAULT_JERSEYS.map(j => ({ jersey: j, holderPlayerId: null }));
      return s;
    } catch {
      localStorage.removeItem(KEY);
      return loadState();
    }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  let state = loadState();

  // ---------------- Utils ----------------
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const clampInt = (v, min, max) => {
    const n = Number.parseInt(v, 10);
    if (Number.isNaN(n)) return min;
    return Math.max(min, Math.min(max, n));
  };
  const byName = (a,b) => a.name.localeCompare(b.name, "fr");

  function upsertPlayer(name){
    const clean = (name || "").trim();
    if (!clean) return null;
    const existing = state.players.find(p => p.name.toLowerCase() === clean.toLowerCase());
    if (existing) return existing;
    const p = { id: uid(), name: clean };
    state.players.push(p);
    state.players.sort(byName);
    saveState(state);
    return p;
  }

  function inferTournamentType(N, names){
    const hasJP = names.includes("JP");
    const hasLouis = names.includes("Louis");
    const hasEloi = names.includes("Eloi");

    if (N >= 6 && hasJP && hasLouis && hasEloi) return "major";
    if (N >= 6) return "monster1000";
    if (N === 5 || N === 4) return "murge500";
    if (N === 3) return "chamangeurs250";
    if (N === 2) return "golems100";
    return "golems100";
  }

  function getTournamentBase(typeKey){
    const t = TOURNAMENTS.find(x => x.key === typeKey);
    return t ? t.base : 0;
  }

  function pointsForRank(base, N, rank){
    if (N <= 1) return base;
    const x = (N - rank) / (N - 1); // 1..0
    const raw = MIN_FRAC + (1 - MIN_FRAC) * Math.pow(x, P_EXP);
    return base * raw;
  }

  function applyTeamBonus(points, teamPos){
    if (!teamPos) return points;
    if (teamPos === 1) return points * 1.10;
    if (teamPos === 3) return points * 0.90;
    return points; // 2
  }

  function computeRanking(){
    const totals = new Map(); // playerId -> points
    state.players.forEach(p => totals.set(p.id, 0));

    for (const tour of state.tournaments){
      const base = getTournamentBase(tour.typeKey);
      const N = tour.players.length;

      for (const res of tour.players){
        const indiv = pointsForRank(base, N, res.rank);
        const withTeam = applyTeamBonus(indiv, res.teamPos);
        totals.set(res.playerId, (totals.get(res.playerId) || 0) + withTeam);
      }
    }

    const rows = state.players.map(p => ({
      playerId: p.id,
      name: p.name,
      points: totals.get(p.id) || 0
    }));

    rows.sort((a,b) => b.points - a.points || a.name.localeCompare(b.name, "fr"));
    return rows;
  }

  // ---------------- Views ----------------
  const viewRanking = document.getElementById("view-ranking");
  const viewAdd = document.getElementById("view-add");
  const viewJerseys = document.getElementById("view-jerseys");

  function renderRanking(){
    const ranking = computeRanking();

    const last = state.tournaments[state.tournaments.length - 1];
    const lastText = last
      ? `${TOURNAMENTS.find(t => t.key === last.typeKey)?.name || last.typeKey} | ${last.dateISO}`
      : "Aucun tournoi enregistré";

    viewRanking.innerHTML = `
      <div class="row" style="justify-content:space-between; margin-bottom:12px">
        <div>
          <h2>Classement</h2>
          <div class="notice">Dernier tournoi: ${escapeHtml(lastText)}</div>
        </div>
        <button class="btn2" id="btn-wipe">Reset local</button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:70px">Rang</th>
            <th>Joueur</th>
            <th style="width:160px">Points</th>
          </tr>
        </thead>
        <tbody>
          ${ranking.map((r, i) => `
            <tr>
              <td>${i+1}</td>
              <td>${escapeHtml(r.name)}</td>
              <td>${formatPoints(r.points)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="notice">
        Points par tournoi: base * (0.10 + 0.90 * ((N-rank)/(N-1))^${P_EXP}). Bonus équipe: +10% gagnants, 0% 2e, -10% derniers.
      </div>
    `;

    document.getElementById("btn-wipe").addEventListener("click", () => {
      localStorage.removeItem(KEY);
      state = loadState();
      renderAll();
    });
  }

  function renderAdd(){
    const options = state.players.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");

    viewAdd.innerHTML = `
      <h2>Ajouter un tournoi</h2>

      <div class="grid">
        <div>
          <label>Date</label><br/>
          <input id="tour-date" type="date" />
        </div>

        <div>
          <label>Type (auto conseillé)</label><br/>
          <select id="tour-type">
            ${TOURNAMENTS.map(t => `<option value="${t.key}">${t.name} (base ${t.base})</option>`).join("")}
          </select>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div style="flex:1; min-width:220px">
          <label>Ajouter un joueur existant</label><br/>
          <select id="pick-player" style="width:100%">
            <option value="">Sélectionner…</option>
            ${options}
          </select>
        </div>

        <div style="flex:1; min-width:220px">
          <label>Ou créer un nouveau joueur</label><br/>
          <input id="new-player" type="text" placeholder="Nom (ex: Matis)" style="width:100%" />
        </div>

        <div style="align-self:flex-end">
          <button class="btn2" id="btn-add-player">Ajouter à la partie</button>
        </div>
      </div>

      <div class="notice">
        Règle Major: 6+ joueurs et présence de JP, Louis, Eloi. Sinon 6+ = Monster 1000, 4-5 = Murge 500, 3 = Chamangeurs 250, 2 = Golems 100.
      </div>

      <div style="height:14px"></div>

      <div id="players-area"></div>

      <div style="height:14px"></div>

      <div class="row" style="justify-content:space-between">
        <div class="muted" id="auto-suggest"></div>
        <button class="btn" id="btn-save">Enregistrer le tournoi</button>
      </div>

      <div class="notice danger" id="add-error" style="display:none"></div>
    `;

    const dateInput = document.getElementById("tour-date");
    const typeSelect = document.getElementById("tour-type");
    const pickPlayer = document.getElementById("pick-player");
    const newPlayer = document.getElementById("new-player");
    const addBtn = document.getElementById("btn-add-player");
    const area = document.getElementById("players-area");
    const saveBtn = document.getElementById("btn-save");
    const autoSuggest = document.getElementById("auto-suggest");
    const err = document.getElementById("add-error");

    // default date today
    const today = new Date();
    dateInput.value = today.toISOString().slice(0,10);

    /** @type {{playerId:string, name:string, rank:number, teamPos:number|null}[]} */
    let current = [];

    function refresh(){
      area.innerHTML = `
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <div><strong>Participants (${current.length})</strong></div>
          <button class="btn2" id="btn-clear">Vider</button>
        </div>

        ${current.length === 0 ? `<div class="notice">Ajoute des joueurs, puis renseigne leur rang fin de partie (1..N). Bonus équipe optionnel.</div>` : ""}

        ${current.map((c, idx) => `
          <div class="playerLine">
            <div><strong>${escapeHtml(c.name)}</strong></div>

            <div>
              <label>Rang</label><br/>
              <input data-rank="${idx}" type="number" min="1" step="1" value="${c.rank}" />
            </div>

            <div>
              <label>Équipe (option)</label><br/>
              <select data-team="${idx}">
                <option value="" ${c.teamPos===null ? "selected" : ""}>Aucune</option>
                <option value="1" ${c.teamPos===1 ? "selected" : ""}>1re (+10%)</option>
                <option value="2" ${c.teamPos===2 ? "selected" : ""}>2e (0%)</option>
                <option value="3" ${c.teamPos===3 ? "selected" : ""}>Dernière (-10%)</option>
              </select>
            </div>

            <div style="text-align:right">
              <button class="btn2" data-remove="${idx}">Retirer</button>
            </div>
          </div>
        `).join("")}
      `;

      area.querySelector("#btn-clear")?.addEventListener("click", () => {
        current = [];
        refresh();
      });

      area.querySelectorAll("button[data-remove]").forEach(b => {
        b.addEventListener("click", () => {
          const i = clampInt(b.getAttribute("data-remove"), 0, 1e9);
          current.splice(i,1);
          refresh();
        });
      });

      area.querySelectorAll("input[data-rank]").forEach(inp => {
        inp.addEventListener("input", () => {
          const i = clampInt(inp.getAttribute("data-rank"), 0, 1e9);
          current[i].rank = clampInt(inp.value, 1, 999);
        });
      });

      area.querySelectorAll("select[data-team]").forEach(sel => {
        sel.addEventListener("change", () => {
          const i = clampInt(sel.getAttribute("data-team"), 0, 1e9);
          const v = sel.value === "" ? null : clampInt(sel.value, 1, 3);
          current[i].teamPos = v;
        });
      });

      // auto suggest type
      const names = current.map(x => x.name);
      const suggested = inferTournamentType(current.length, names);
      const suggestedName = TOURNAMENTS.find(t => t.key === suggested)?.name || suggested;
      autoSuggest.textContent = current.length >= 2
        ? `Type conseillé: ${suggestedName}`
        : "";

      err.style.display = "none";
      err.textContent = "";
    }

    function addParticipant(player){
      if (current.some(x => x.playerId === player.id)) return;
      current.push({ playerId: player.id, name: player.name, rank: current.length + 1, teamPos: null });
      refresh();
    }

    addBtn.addEventListener("click", () => {
      const pid = pickPlayer.value;
      const name = newPlayer.value.trim();

      if (pid){
        const p = state.players.find(x => x.id === pid);
        if (p) addParticipant(p);
        pickPlayer.value = "";
        return;
      }

      if (name){
        const p = upsertPlayer(name);
        if (p) addParticipant(p);
        newPlayer.value = "";
        // refresh player dropdown list
        renderAdd();
        return;
      }

      err.style.display = "block";
      err.textContent = "Sélectionne un joueur existant ou crée un nouveau joueur.";
    });

    saveBtn.addEventListener("click", () => {
      const N = current.length;
      if (N < 2){
        err.style.display = "block";
        err.textContent = "Il faut au moins 2 joueurs.";
        return;
      }

      // Validate ranks unique and within 1..N
      const ranks = current.map(x => x.rank);
      const allInRange = ranks.every(r => r >= 1 && r <= N);
      const unique = new Set(ranks).size === ranks.length;
      if (!allInRange || !unique){
        err.style.display = "block";
        err.textContent = "Les rangs doivent être uniques et compris entre 1 et N.";
        return;
      }

      const dateISO = dateInput.value || new Date().toISOString().slice(0,10);

      // You can keep manual type, but we could auto override if you want later
      const typeKey = typeSelect.value;

      const tournament = {
        id: uid(),
        dateISO,
        typeKey,
        players: current.map(x => ({
          playerId: x.playerId,
          rank: x.rank,
          teamPos: x.teamPos
        }))
      };

      state.tournaments.push(tournament);
      saveState(state);

      // reset current
      current = [];
      refresh();
      renderRanking();
      switchView("ranking");
    });

    refresh();
  }

  function renderJerseys(){
    const ranking = computeRanking();
    const playerOptions = (selectedId) => `
      <option value="">Non attribué</option>
      ${ranking.map(r => `<option value="${r.playerId}" ${r.playerId===selectedId ? "selected" : ""}>${escapeHtml(r.name)}</option>`).join("")}
    `;

    viewJerseys.innerHTML = `
      <h2>Maillots</h2>
      <div class="notice">Titulaires courants. Mise à jour manuelle (V1). V2 pourra calculer automatiquement des maillots “performance”.</div>
      <div style="height:10px"></div>

      ${state.jerseys.map((j, idx) => `
        <div class="row" style="justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border)">
          <div><strong>${escapeHtml(j.jersey)}</strong></div>
          <div>
            <select data-jersey="${idx}">
              ${playerOptions(j.holderPlayerId)}
            </select>
          </div>
        </div>
      `).join("")}

      <div style="height:14px"></div>
      <button class="btn" id="btn-save-jerseys">Enregistrer</button>
    `;

    viewJerseys.querySelector("#btn-save-jerseys").addEventListener("click", () => {
      viewJerseys.querySelectorAll("select[data-jersey]").forEach(sel => {
        const i = clampInt(sel.getAttribute("data-jersey"), 0, 1e9);
        state.jerseys[i].holderPlayerId = sel.value || null;
      });
      saveState(state);
      renderJerseys();
    });
  }

  function renderAll(){
    renderRanking();
    renderAdd();
    renderJerseys();
  }

  // ---------------- Navigation ----------------
  function switchView(name){
    document.querySelectorAll(".tab").forEach(b => {
      b.classList.toggle("active", b.getAttribute("data-view") === name);
    });
    viewRanking.style.display = name === "ranking" ? "block" : "none";
    viewAdd.style.display = name === "add" ? "block" : "none";
    viewJerseys.style.display = name === "jerseys" ? "block" : "none";
  }

  document.querySelectorAll(".tab").forEach(b => {
    b.addEventListener("click", () => switchView(b.getAttribute("data-view")));
  });

  // ---------------- Formatting ----------------
  function formatPoints(x){
    return Math.round(x).toLocaleString("fr-FR");
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------------- Init ----------------
  renderAll();
})();
</script>
</body>
</html>
